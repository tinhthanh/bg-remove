<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Integration Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/penpal@^7/dist/penpal.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f3f4f6;
        }
        .checkerboard {
            background-color: #fff;
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(-45deg, #e5e7eb 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e5e7eb 75%),
                linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .log-entry {
            font-family: monospace;
            border-bottom: 1px solid #374151;
            padding: 4px 0;
        }
        .log-time { color: #9ca3af; margin-right: 8px; }
        .log-info { color: #60a5fa; }
        .log-success { color: #34d399; }
        .log-error { color: #f87171; }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üõ†Ô∏è</span>
                <h1 class="text-xl font-bold text-gray-900">Background Removal <span class="text-blue-600">Integration Playground</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="connectionStatus" class="flex items-center gap-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium transition-colors">
                    <span class="w-2 h-2 bg-yellow-500 rounded-full animate-pulse"></span>
                    Connecting...
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 gap-6 grid grid-cols-1 lg:grid-cols-12">
        
        <!-- Left Column: Controls & Preview -->
        <div class="lg:col-span-7 space-y-6">
            
            <!-- Upload Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    1. Input Image
                    <span class="text-xs font-normal text-gray-500 px-2 py-0.5 bg-gray-100 rounded">Supports paste (Ctrl+V)</span>
                </h2>
                
                <div class="flex items-start gap-4">
                    <div class="flex-1">
                        <label class="block w-full cursor-pointer group">
                            <input type="file" id="imageInput" accept="image/*" class="hidden">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all group-hover:scale-[1.01]">
                                <div class="text-4xl mb-2">üìÅ</div>
                                <p class="text-sm font-medium text-gray-900">Click to upload</p>
                                <p class="text-xs text-gray-500 mt-1">PNG, JPG, WebP supported</p>
                            </div>
                        </label>
                    </div>
                    <div class="w-32 flex flex-col gap-2">
                        <button id="preloadBtn" class="w-full px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors text-left flex items-center gap-2">
                            <span>‚ö°</span> Pre-load
                        </button>
                        <button id="processBtn" disabled class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm text-left flex items-center gap-2">
                            <span>‚ñ∂Ô∏è</span> Process
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">2. Result Comparison</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <!-- Original -->
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-500 text-center">Original</p>
                        <div class="aspect-square rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center relative">
                            <img id="originalPreview" class="max-w-full max-h-full object-contain hidden">
                            <span id="originalPlaceholder" class="text-gray-400 text-sm">No image</span>
                        </div>
                    </div>

                    <!-- Processed -->
                    <div class="space-y-2">
                        <p class="text-sm font-medium text-gray-500 text-center">Removed Background</p>
                        <div class="aspect-square rounded-lg border border-gray-200 checkerboard overflow-hidden flex items-center justify-center relative group">
                            <img id="processedPreview" class="max-w-full max-h-full object-contain hidden z-10 relative">
                            <div id="processedPlaceholder" class="text-gray-400 text-sm z-10 relative">Waiting...</div>
                            
                            <!-- Loading Overlay -->
                            <div id="loadingOverlay" class="absolute inset-0 bg-white/80 z-20 hidden flex-col items-center justify-center backdrop-blur-sm">
                                <div class="w-8 h-8 border-3 border-blue-600 border-t-transparent rounded-full animate-spin mb-2"></div>
                                <p class="text-xs font-medium text-blue-600">Processing...</p>
                                <p id="timer" class="text-xs text-gray-500 mt-1">0.0s</p>
                            </div>

                            <!-- Download Action -->
                            <a id="downloadLink" class="absolute bottom-2 right-2 z-30 bg-gray-900 text-white p-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-800 hidden cursor-pointer" title="Download">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Logs & Code -->
        <div class="lg:col-span-5 space-y-6 flex flex-col h-full">
            
            <!-- Integration Code Snippet -->
            <div class="bg-gray-900 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                    <span class="text-xs font-mono text-gray-400">integration-example.js</span>
                    <button class="text-xs text-blue-400 hover:text-blue-300" onclick="copyCode()">Copy</button>
                </div>
                <pre class="p-4 text-xs overflow-x-auto text-gray-300"><code class="language-javascript">import { connect, WindowMessenger } from 'penpal';

// K·∫øt n·ªëi t·ªõi Service Iframe
const connection = connect({
  messenger: new WindowMessenger({
    remoteWindow: iframe.contentWindow,
    // Cho ph√©p giao ti·∫øp v·ªõi domain hi·ªán t·∫°i
    allowedOrigins: [window.location.origin],
  })
});

const service = await connection.promise;
const blob = await service.removeBackgroundAsBlob(file);</code></pre>
            </div>

            <!-- Event Log Console -->
            <div class="bg-gray-900 rounded-xl shadow-sm border border-gray-700 flex-1 flex flex-col min-h-[300px] overflow-hidden">
                <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                    <span class="text-xs font-mono text-gray-400">Console Logs</span>
                    <button onclick="clearLogs()" class="text-xs text-gray-500 hover:text-gray-300">Clear</button>
                </div>
                <div id="consoleLogs" class="p-4 font-mono text-xs overflow-y-auto flex-1 max-h-[400px]">
                    <!-- Logs will appear here -->
                    <div class="text-gray-500 italic">Waiting for events...</div>
                </div>
            </div>
            
            <!-- Hidden Iframe for Service -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 opacity-75 hover:opacity-100 transition-opacity">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Service Iframe (Debug View)</h3>
                <!-- FIX: Thay ƒë·ªïi src t·ª´ "/" th√†nh "/remove-bg/" ƒë·ªÉ tr·ªè ƒë√∫ng v√†o app -->
                <iframe id="bgRemovalIframe" src="/remove-bg/" class="w-full h-24 border border-gray-200 rounded bg-gray-50"></iframe>
            </div>

        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

    <script>
        // --- UI Elements ---
        const imageInput = document.getElementById('imageInput');
        const processBtn = document.getElementById('processBtn');
        const preloadBtn = document.getElementById('preloadBtn');
        const originalPreview = document.getElementById('originalPreview');
        const originalPlaceholder = document.getElementById('originalPlaceholder');
        const processedPreview = document.getElementById('processedPreview');
        const processedPlaceholder = document.getElementById('processedPlaceholder');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const timerEl = document.getElementById('timer');
        const connectionStatus = document.getElementById('connectionStatus');
        const downloadLink = document.getElementById('downloadLink');
        const consoleLogs = document.getElementById('consoleLogs');
        const iframe = document.getElementById('bgRemovalIframe');

        let selectedFile = null;
        let service = null;
        let timerInterval = null;

        // --- Logging Utility ---
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = 'log-entry';
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
            
            let colorClass = 'text-gray-300';
            if (type === 'info') colorClass = 'log-info';
            if (type === 'success') colorClass = 'log-success';
            if (type === 'error') colorClass = 'log-error';

            div.innerHTML = `<span class="log-time">[${time}]</span><span class="${colorClass}">${message}</span>`;
            
            if (consoleLogs.children.length === 1 && consoleLogs.children[0].classList.contains('italic')) {
                consoleLogs.innerHTML = '';
            }
            
            consoleLogs.appendChild(div);
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        }

        function clearLogs() {
            consoleLogs.innerHTML = '<div class="text-gray-500 italic">Logs cleared.</div>';
        }

        // --- Penpal Connection ---
        log('Initializing Penpal connection...');
        
        const connection = Penpal.connect({
            messenger: new Penpal.WindowMessenger({
                remoteWindow: iframe.contentWindow,
                // Cho ph√©p domain hi·ªán t·∫°i (t·ª± ƒë·ªông nh·∫≠n di·ªán host v√† port)
                allowedOrigins: [window.location.origin],
            }),
            timeout: 30000
        });

        connection.promise.then(remote => {
            service = remote;
            log('‚úÖ Connected to Background Service', 'success');
            
            // Update UI Status
            connectionStatus.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium';
            connectionStatus.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full"></span>Connected';
            
            // Get Info
            service.getModelInfo().then(info => {
                log(`‚ÑπÔ∏è Model Info: ID=${info.currentModelId}, WebGPU=${info.isWebGPUSupported}, iOS=${info.isIOS}`, 'info');
            });

        }).catch(err => {
            log(`‚ùå Connection Failed: ${err.message}`, 'error');
            connectionStatus.className = 'flex items-center gap-2 px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium';
            connectionStatus.innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span>Offline';
        });

        // --- Event Handlers ---

        imageInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        // Paste support
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    handleFile(item.getAsFile());
                }
            }
        });

        function handleFile(file) {
            if (!file) return;
            selectedFile = file;
            
            const url = URL.createObjectURL(file);
            originalPreview.src = url;
            originalPreview.classList.remove('hidden');
            originalPlaceholder.classList.add('hidden');
            
            processBtn.disabled = false;
            processedPreview.classList.add('hidden');
            processedPlaceholder.classList.remove('hidden');
            downloadLink.classList.add('hidden');
            
            log(`üì∏ Loaded image: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');
        }

        processBtn.addEventListener('click', async () => {
            if (!service || !selectedFile) return;

            // UI Reset
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('flex');
            processBtn.disabled = true;
            let startTime = Date.now();
            timerEl.innerText = '0.0s';
            
            timerInterval = setInterval(() => {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                timerEl.innerText = `${elapsed}s`;
            }, 100);

            try {
                log('üîÑ Sending request to service...', 'info');
                
                // Call the service (Using Blob for better performance)
                const blob = await service.removeBackgroundAsBlob(selectedFile);
                
                const duration = ((Date.now() - startTime) / 1000).toFixed(2);
                log(`‚úÖ Processed in ${duration}s`, 'success');

                // Display result
                const url = URL.createObjectURL(blob);
                processedPreview.src = url;
                processedPreview.classList.remove('hidden');
                processedPlaceholder.classList.add('hidden');
                
                // Setup download
                downloadLink.href = url;
                downloadLink.download = `processed-${Date.now()}.png`;
                downloadLink.classList.remove('hidden');

            } catch (err) {
                log(`‚ùå Error: ${err.message}`, 'error');
                alert('Error: ' + err.message);
            } finally {
                clearInterval(timerInterval);
                loadingOverlay.classList.add('hidden');
                loadingOverlay.classList.remove('flex');
                processBtn.disabled = false;
            }
        });

        preloadBtn.addEventListener('click', async () => {
            if (!service) return;
            preloadBtn.disabled = true;
            preloadBtn.innerHTML = '<span>‚è≥</span> Loading...';
            log('‚ö° Initializing model manually...', 'info');
            
            try {
                await service.initializeModel();
                log('‚ú® Model initialized and ready!', 'success');
                preloadBtn.innerHTML = '<span>‚úÖ</span> Ready';
            } catch (err) {
                log(`‚ùå Init Failed: ${err.message}`, 'error');
                preloadBtn.innerHTML = '<span>‚ö†Ô∏è</span> Failed';
                preloadBtn.disabled = false;
            }
        });

        function copyCode() {
            const code = document.querySelector('code').innerText;
            navigator.clipboard.writeText(code);
            log('üìã Code copied to clipboard', 'info');
        }
    </script>
</body>
</html>
